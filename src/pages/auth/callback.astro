---
// Auth callback handler - processes OAuth redirect
import "../../styles/global.css";

const title = "Signing you in... | Robin Gautam";
---

<!doctype html>
<html lang="en" class="scroll-smooth">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{title}</title>

        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
            rel="stylesheet"
        />
    </head>

    <body
        class="bg-midnight-950 text-white font-sans antialiased noise-bg min-h-screen flex items-center justify-center"
    >
        <!-- Background Glows -->
        <div
            class="fixed top-1/2 left-1/4 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-accent/10 rounded-full blur-[150px] pointer-events-none"
        >
        </div>
        <div
            class="fixed top-1/3 right-1/4 w-[400px] h-[400px] bg-purple-500/5 rounded-full blur-[120px] pointer-events-none"
        >
        </div>

        <div class="relative z-10 text-center">
            <!-- Loading Animation -->
            <div id="loading-state" class="flex flex-col items-center gap-6">
                <div
                    class="w-16 h-16 rounded-2xl bg-gradient-to-br from-accent to-accent-dark flex items-center justify-center animate-pulse"
                >
                    <span class="text-white font-bold text-2xl">R</span>
                </div>
                <div class="space-y-2">
                    <div
                        class="w-12 h-12 border-4 border-accent/30 border-t-accent rounded-full animate-spin mx-auto"
                    >
                    </div>
                    <h1 class="text-xl font-semibold mt-4">
                        Signing you in...
                    </h1>
                    <p class="text-zinc-400">
                        Please wait while we complete the authentication.
                    </p>
                </div>
            </div>

            <!-- Success State -->
            <div
                id="success-state"
                class="hidden flex flex-col items-center gap-6"
            >
                <div
                    class="w-16 h-16 rounded-2xl bg-green-500/20 border border-green-500/30 flex items-center justify-center"
                >
                    <svg
                        class="w-8 h-8 text-green-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <div class="space-y-2">
                    <h1 class="text-xl font-semibold">Welcome!</h1>
                    <p class="text-zinc-400">
                        You've been signed in successfully.
                    </p>
                    <p class="text-zinc-500 text-sm">
                        Redirecting you to the homepage...
                    </p>
                </div>
            </div>

            <!-- Error State -->
            <div
                id="error-state"
                class="hidden flex flex-col items-center gap-6"
            >
                <div
                    class="w-16 h-16 rounded-2xl bg-red-500/20 border border-red-500/30 flex items-center justify-center"
                >
                    <svg
                        class="w-8 h-8 text-red-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
                <div class="space-y-2">
                    <h1 class="text-xl font-semibold">Authentication Failed</h1>
                    <p class="text-zinc-400">
                        Something went wrong during sign-in.
                    </p>
                    <a
                        href="/login"
                        class="inline-flex items-center gap-2 text-accent hover:text-accent-light transition-colors mt-4"
                    >
                        <svg
                            class="w-4 h-4"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Try again
                    </a>
                </div>
            </div>
        </div>

        <script type="module">
            import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

            const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || "";
            const supabaseAnonKey =
                import.meta.env.PUBLIC_SUPABASE_ANON_KEY || "";

            const supabase = createClient(supabaseUrl, supabaseAnonKey, {
                auth: {
                    autoRefreshToken: true,
                    persistSession: true,
                    detectSessionInUrl: true,
                    flowType: "pkce",
                },
            });

            const loadingState = document.getElementById("loading-state");
            const successState = document.getElementById("success-state");
            const errorState = document.getElementById("error-state");

            function showState(state) {
                loadingState.classList.add("hidden");
                successState.classList.add("hidden");
                errorState.classList.add("hidden");

                if (state === "loading")
                    loadingState.classList.remove("hidden");
                if (state === "success")
                    successState.classList.remove("hidden");
                if (state === "error") errorState.classList.remove("hidden");
            }

            async function handleCallback() {
                try {
                    // Get the hash fragment from the URL (for implicit flow)
                    const hashParams = new URLSearchParams(
                        window.location.hash.substring(1),
                    );
                    const accessToken = hashParams.get("access_token");
                    const refreshToken = hashParams.get("refresh_token");

                    // Check for error in URL params
                    const urlParams = new URLSearchParams(
                        window.location.search,
                    );
                    const error = urlParams.get("error");
                    const errorDescription = urlParams.get("error_description");

                    if (error) {
                        console.error("Auth error:", error, errorDescription);
                        showState("error");
                        return;
                    }

                    // If we have tokens in hash, set the session
                    if (accessToken) {
                        const { data, error } = await supabase.auth.setSession({
                            access_token: accessToken,
                            refresh_token: refreshToken || "",
                        });

                        if (error) throw error;

                        showState("success");
                        setTimeout(() => {
                            window.location.href = "/";
                        }, 1500);
                        return;
                    }

                    // Otherwise, check if session was set via PKCE flow
                    const {
                        data: { session },
                        error: sessionError,
                    } = await supabase.auth.getSession();

                    if (sessionError) throw sessionError;

                    if (session) {
                        showState("success");
                        setTimeout(() => {
                            window.location.href = "/";
                        }, 1500);
                    } else {
                        // No session found, might still be processing
                        // Wait a bit and check again
                        setTimeout(async () => {
                            const {
                                data: { session: retrySession },
                            } = await supabase.auth.getSession();
                            if (retrySession) {
                                showState("success");
                                setTimeout(() => {
                                    window.location.href = "/";
                                }, 1500);
                            } else {
                                showState("error");
                            }
                        }, 2000);
                    }
                } catch (error) {
                    console.error("Callback error:", error);
                    showState("error");
                }
            }

            // Handle the auth callback
            handleCallback();
        </script>
    </body>
</html>
